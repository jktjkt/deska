% vim: spelllang=en spell textwidth=120
\documentclass[deska]{subfiles}
\begin{document}

\chapter{Configuring the Database Scheme}
\label{sec:admin-dbscheme}

\begin{abstract}
This chapter leads the Deska administrator through the process of customizing the database scheme to individual site's
needs, as well as through the deployment of the database side.
\end{abstract}

FIXME: tell the user how to actually configure the scheme; that's the part of the end-user docs.

\section{Requirements on the Table Layout}
\label{sec:db-scheme-req}

\subsection{General Requirements}
Every SQL table provided by the user needs to:

\begin{itemize}
    \item Set {\tt search\_path} to schemas {\tt production} and {\tt deska}
    \item Have primary key column {\tt uid} of the {\tt bigint} type
    \item Have unique, not null column {\tt name} of the {\tt identifier} type; the embedded tables should instead use a
        unique pair of a {\tt uid} and a referencing column (see \secref{sec:db-scheme-refers-to} for an example).
    \item Use a sequence's {\tt nextval} as the default value of the column {\tt uid}
\end{itemize}

Following example shows a simplest table to be used in Deska.

\begin{minted}{sql}
--
-- This is example of a user-provided table for Deska.
-- It does not provide any attributes.
--
--
SET search_path TO production, deska;

CREATE SEQUENCE vendor_uid START 1;

-- vendor is the name of this kind
CREATE TABLE vendor (
    -- An internal primary key
    uid bigint DEFAULT nextval('vendor_uid')
        CONSTRAINT vendor_pk PRIMARY KEY,
    -- Name is the user-visible identifier
    name identifier
        CONSTRAINT vendor_name_unique UNIQUE NOT NULL
);
\end{minted}

It is not recommended to use table names starting with a prefix {\tt "inner\_"}, or ending with {\tt "\_template"}, as
Deska uses these names for internal use.  The total maximum length of a kind name and an attribute name is 20 characters
together.  Foreign keys have to retain the {\tt ON DELETE NO ACTION} stanza, a default option. All foreign keys also
needs to be set to {\tt DEFERRABLE}.

\subsection{Relations Definition}
Here we will describe how to add Deska relations to modules.

FIXME: add proper cross-references

\subsubsection{REFERS\_TO}
\label{sec:db-scheme-refers-to}

The {\tt REFERS\_TO} relation (see \secref{sec:relation-refers-to}) needs adding the foreign key constraint. This
constraint have to:

\begin{itemize}
    \item The target module table has to be present in the database already
    \item The referring column forming the relation has to be of the {\tt bigint} type
    \item The name of the constraint shall start with the {\tt rrefer\_} prefix
    \item The foreign key shall always reference the {\tt uid} column of the target table
\end{itemize}

FIXME: there's a discrepancy between what the docs say (``has to start with rrefer\_'') and what the example suggests
below. Martina, please fix this one.

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE hardware_uid START 1;

CREATE TABLE hardware (
    uid bigint DEFAULT nextval('hardware_uid')
        CONSTRAINT hardware_pk PRIMARY KEY,
    name identifier
        CONSTRAINT hardware_name_unique UNIQUE NOT NULL,
    vendor bigint 
        CONSTRAINT hardware_fk_vendor REFERENCES vendor(uid) DEFERRABLE,
);
\end{minted}

\subsection{EMBED\_INTO}
The {\tt EMBED\_INTO} relation needs adding the foreign key constraint. This constraint have to:
\begin{itemize}
    \item refer to module that will be installed before this one
    \item have referring column of bigint type
    \item have name with {\tt rembed\_} prefix
    \item refer to uid column of the referenced table
\end{itemize}
The tables that are embed into another have to have unique pair of uid and referencing column, which refers to uid of table that is this embed into.
\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE interface_uid START 1;

-- interfaces of host
CREATE TABLE interface (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('interface_uid')
        CONSTRAINT interface_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier NOT NULL,
    host bigint
        CONSTRAINT rembed_interface_fk_host REFERENCES host(uid) DEFERRABLE,
    CONSTRAINT interface_pk_namexhost UNIQUE (name,host)
);
\end{minted}



\subsubsection{Template}
Template relation needs adding special column to the module. This column have to:
\begin{itemize}
    \item have name with {\tt template\_} prefix
    \item be the only one column in module with name with {\tt template\_} prefix
    \item be of bigint type
\end{itemize}
You can template only tables that have at least one column which value could be inherited from its template. Columns that are a part of composition relation, template relation or embed into relation could not inherit theirs values.

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE hardware_uid START 1;

CREATE TABLE hardware (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('hardware_uid')
        CONSTRAINT hardware_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT hardware_name_unique UNIQUE NOT NULL,
    vendor bigint 
        CONSTRAINT hardware_fk_vendor REFERENCES vendor(uid) DEFERRABLE,
    template_hardware bigint
);
\end{minted}


\subsubsection{Multi-value Reference}
Multi-value reference relation needs adding the foreign key constrain. This constraint have to:
\begin{itemize}
    \item refer to module that will be installed before this one
    \item have referring column of {\tt identifier\_set} type
    \item have name with {\tt rset\_} prefix
    \item refer to uid column of the referenced table
\end{itemize}

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE host_uid START 1;

CREATE TABLE host (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('host_uid')
        CONSTRAINT host_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT host_name_unique UNIQUE NOT NULL,
    service identifier_set
        CONSTRAINT rset_host_fk_service REFERENCES service(uid) DEFERRABLE,
);
\end{minted}

\subsubsection{Composition}
Composition relation needs adding the foreign key constrain. This constraint have to:
\begin{itemize}
    \item refer to module that will be installed before this one
    \item have referring column of bigint type
    \item have name with {\tt rconta\_} prefix
    \item refer to uid column of the referenced table
\end{itemize}
In addition to requirements on module's foreign key, it is needed that:
\begin{itemize}
    \item this module and referenced module do not have any attribute with the same name (of course except name and uid)
    \item the chain created by composition foreign keys of defined modules do not contain a cycle
\end{itemize}

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE host_uid START 1;

-- vendors of hw
CREATE TABLE host (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('host_uid')
        CONSTRAINT host_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT host_name_unique UNIQUE NOT NULL,
    -- hardwere where it runs
    hardware bigint
        CONSTRAINT rconta_host_fk_hardware REFERENCES hardware(uid) DEFERRABLE,
);
\end{minted}

\end{document}
