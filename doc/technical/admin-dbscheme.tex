% vim: spelllang=en spell textwidth=120
\documentclass[deska]{subfiles}
\begin{document}

\chapter{Configuring the Deska Schema}
\label{sec:admin-dbscheme}

\begin{abstract}
This chapter leads the Deska administrator through the process of customizing the database scheme to individual site's
needs, as well as through the deployment of the database side.
\end{abstract}

\todo{Lukas: tell the user how to actually configure the scheme; that's the part of the end-user docs.}
\section{Schema creation}
After you get Deska software installed, you have to create {\em Deska schema}. If you work with
deska-cli, you work with objects, its attributes and relations between them as told in \secref{sec:objects-and-relations}.
This is the part where kinds of this objects a and relation between this kinds are defined. Every kind have can have some attributes. These attributes can have defined some constraints. And relation can be defined between kinds.
All this is described in {\tt Deska schema}.

For defining Deska schema we use SQL tables, attributes (or columns), constraints and triggers.
To define relation we use standard SQL foreign keys with small addition - special prefix of constraint name.
The Deska schema definition is in fact standard SQL schema commands, creating standard SQL schema with some
special requirements (will be described in \secref{sec:db-scheme-req}.

\subsection{Kind Creation}
If you want to create kind, create table in SQL with same name as your kind should have.
We recommend to have one table in one SQL file. Start the name of the file with number,
to determine the order in which files are loaded in the database.

Every table should have at least 2 columns (attributes). Uid, which is Deska internal primary key.
And name, which is identifier of each object. You can create more attributes of various types described in
\secref{sec:db-att-types}.

\section{Requirements on the Table Layout}
\label{sec:db-scheme-req}

Every SQL file should start with
setting {\tt search\_path} to schemas {\tt production} and {\tt deska}.

Every SQL table provided by the user needs to:
\begin{itemize}
    \item Have primary key column {\tt uid} of the {\tt bigint} type
    \item Have unique, not null column {\tt name} of the {\tt identifier} type; the embedded tables should instead use a
        unique pair of a {\tt uid} and a referencing column (see \secref{sec:db-scheme-refers-to} for an example)
    \item Use a sequence's {\tt nextval} as the default value of the column {\tt uid}
\end{itemize}

Following example shows a simplest table to be used in Deska.

\begin{minted}{sql}
SET search_path TO production, deska;

CREATE SEQUENCE vendor_uid START 1;

-- vendor is the name of this kind
CREATE TABLE vendor (
    -- An internal primary key
    uid bigint DEFAULT nextval('vendor_uid')
        CONSTRAINT vendor_pk PRIMARY KEY,
    -- Name is the user-visible identifier
    name identifier
        CONSTRAINT vendor_name_unique UNIQUE NOT NULL
    --HERE can be placed kind attributes, contraints and relation definitions
);
\end{minted}

Do not use table names starting with a prefix {\tt "inner\_"}, or ending with {\tt "\_template"}, as
Deska uses these names for internal use.  The total maximum length of a kind name and an attribute name is 20 characters
together.  Foreign keys have to retain the {\tt ON DELETE NO ACTION} stanza, a default option. All foreign keys also
needs to be set to {\tt DEFERRABLE}.

\subsection{Attribute types}
\label{sec:db-att-types}
Due to performance reasons, we support only subset of Postgresql types and we added some.
Here is the listing of supported types.

\begin{itemize}
	\item{identifier} - this is Deska identifier, it is used for object names.
	\item{identifier\_set} - set of identifiers, use this for multireference attributes
	\item{int} - for whole numbers
	\item{bigint} - for large whole numbers, uids
	\item{real} - for whole numbers
	\item{text} - for strings
	\item{ipv4} - for IP version 4 addresses
	\item{ipv6} - for IP version 6 addresses
	\item{macaddr} - for MAC addresses
	\item{date} - for date
	\item{timestamp} - for timestamp
\begin{end}

\subsection{Relations Definition}
Here we will describe how to add Deska relations (see \secref{sec:objects-and-relations-relations}) to modules.

\todo{Martina: add proper cross-references}

\subsubsection{REFERS\_TO}
\label{sec:db-scheme-refers-to}

The {\tt REFERS\_TO} relation (see \secref{sec:relation-refers-to}) needs adding the foreign key constraint. This constraint has to comply with following rules:

\begin{itemize}
    \item The target module table has to be present in the database already
    \item The referring column forming the relation has to be of the {\tt bigint} type
    \item The name of the constraint shall start with the {\tt rrefer\_} prefix
    \item The foreign key shall always reference the {\tt uid} column of the target table
\end{itemize}

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE hardware_uid START 1;

CREATE TABLE hardware (
    uid bigint DEFAULT nextval('hardware_uid')
        CONSTRAINT hardware_pk PRIMARY KEY,
    name identifier
        CONSTRAINT hardware_name_unique UNIQUE NOT NULL,
    vendor bigint 
        CONSTRAINT rrefer_hardware_fk_vendor REFERENCES vendor(uid) DEFERRABLE,
);
\end{minted}

\subsubsection{EMBED\_INTO}
The {\tt EMBED\_INTO} relation (see \secref{sec:relation-embed-into}) needs adding the foreign key constraint. This constraint has to comply with following rules:
\begin{itemize}
    \item The target module table has to be present in the database already
    \item The referring column forming the relation has to be of the {\tt bigint} type
    \item The name of the constraint shall start with the {\tt rembed\_} prefix
    \item The foreign key shall always reference the {\tt uid} column of the target table
\end{itemize}
The tables that are embedded into another have to have unique pair of uid and referencing column, which refers to uid of table that is this embedded into.
\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE interface_uid START 1;

-- interfaces of host
CREATE TABLE interface (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('interface_uid')
        CONSTRAINT interface_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier NOT NULL,
    host bigint
        CONSTRAINT rembed_interface_fk_host REFERENCES host(uid) DEFERRABLE,
    CONSTRAINT interface_pk_namexhost UNIQUE (name,host)
);
\end{minted}


\subsubsection{TEMPLATIZE}
The {\tt TEMPLATIZE} relation needs (see \secref{sec:relation-templatized}) adding a special column to the module. This column has to comply with following rules:
\begin{itemize}
    \item The name of the column shall start with {\tt template\_} prefix
    \item The column has to be the only one column in module which name starts with {\tt template\_} prefix
    \item The column shall be of the {\tt bigint} type
\end{itemize}
You can template only tables that have at least one column which value could be inherited from its template. Columns that form some {\tt COMPOSITION relation}, {\tt TEMPLATIZE} relation or {\tt EMBED INTO} relation could not inherit theirs values.

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE hardware_uid START 1;

CREATE TABLE hardware (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('hardware_uid')
        CONSTRAINT hardware_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT hardware_name_unique UNIQUE NOT NULL,
    vendor bigint 
        CONSTRAINT hardware_fk_vendor REFERENCES vendor(uid) DEFERRABLE,
    template_hardware bigint
);
\end{minted}


\subsubsection{Multi-value Reference}
{\tt Multi-value} reference relation (see \secref{sec:relation-multi-value-references}) needs adding the foreign key constrain. This constraint has to comply with following rules:
\begin{itemize}
    \item The target module table has to be present in the database already
    \item The referring column forming the relation has to be of the {\tt identifier\_set} type
    \item The name of the constraint shall start with the {\tt rset\_} prefix
    \item The foreign key shall always reference the {\tt uid} column of the target table
\end{itemize}

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE host_uid START 1;

CREATE TABLE host (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('host_uid')
        CONSTRAINT host_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT host_name_unique UNIQUE NOT NULL,
    service identifier_set
        CONSTRAINT rset_host_fk_service REFERENCES service(uid) DEFERRABLE,
);
\end{minted}

\subsubsection{COMPOSITION}
{\tt COMPOSITION} relation (see \secref{sec:relation-contains}) needs adding the foreign key constrain. This constraint has to comply with following rules:
\begin{itemize}
    \item The target module table has to be present in the database already
    \item The referring column forming the relation has to be of the {\tt bigint} type
    \item The name of the constraint shall start with the {\tt rconta\_} prefix
    \item The foreign key shall always reference the {\tt uid} column of the target table
\end{itemize}
In addition to requirements on module's foreign key, it is needed that:
\begin{itemize}
    \item This module and referenced module do not have any attribute with the same name (of course except {\tt name} and {\tt uid})
    \item The chain created by {\tt COMPOSITION} foreign keys of defined modules do not contain a cycle
\end{itemize}

\begin{minted}{sql}
SET search_path TO production,deska;

CREATE SEQUENCE host_uid START 1;

-- vendors of hw
CREATE TABLE host (
    -- this column is required in all plugins
    uid bigint DEFAULT nextval('host_uid')
        CONSTRAINT host_pk PRIMARY KEY,
    -- this column is required in all plugins
    name identifier
        CONSTRAINT host_name_unique UNIQUE NOT NULL,
    -- hardwere where it runs
    hardware bigint
        CONSTRAINT rconta_host_fk_hardware REFERENCES hardware(uid) DEFERRABLE,
);
\end{minted}

\end{document}
